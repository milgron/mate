services:
  mate:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: mate
    restart: unless-stopped
    env_file:
      - ../.env

    # Security hardening
    user: "1001:1001"
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # Temp filesystem for runtime needs
    tmpfs:
      - /tmp:size=512m,noexec,nosuid,nodev

    # Volumes
    volumes:
      # Update trigger (allows bot to trigger self-updates)
      - /var/mate:/var/mate
      # Persistent data storage (memory, conversations, notes, logs)
      - ../data:/app/data
      # Persist Claude CLI auth between rebuilds
      - mate-claude-auth:/home/mate/.claude

    # Environment variables (loaded from ../.env via env_file)
    environment:
      - NODE_ENV=production

    # Resource limits (optimized for Pi 5 8GB)
    deploy:
      resources:
        limits:
          cpus: '3'
          memory: 4G
        reservations:
          memory: 512M

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Development service with hot reload
  mate-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: mate-dev
    profiles:
      - dev

    volumes:
      - ../src:/app/src:ro
      - ../package.json:/app/package.json:ro

    env_file:
      - ../.env
    environment:
      - NODE_ENV=development

volumes:
  mate-claude-auth:
